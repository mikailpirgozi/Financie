#!/usr/bin/env node

const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');

// Load env
const envPath = path.join(__dirname, 'apps/web/.env.local');
const envContent = fs.readFileSync(envPath, 'utf8');
const envVars = {};
envContent.split('\n').forEach(line => {
  const [key, ...valueParts] = line.split('=');
  if (key && valueParts.length) {
    envVars[key.trim()] = valueParts.join('=').trim();
  }
});

const supabaseUrl = envVars.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = envVars.SUPABASE_SERVICE_ROLE_KEY;

const supabase = createClient(supabaseUrl, supabaseServiceKey, {
  auth: { autoRefreshToken: false, persistSession: false }
});

async function diagnoseAndFix() {
  const targetEmail = 'pirgozi1@gmail.com';
  
  console.log(`\nüîç Diagnostika a oprava pre: ${targetEmail}\n`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
  
  // 1. Auth user
  const { data: authUsers } = await supabase.auth.admin.listUsers();
  const user = authUsers.users.find(u => u.email === targetEmail);
  
  if (!user) {
    console.error('‚ùå User neexistuje v auth.users!');
    console.log('\nüí° Rie≈°enie: Zaregistruj sa na /auth/register\n');
    return;
  }
  
  console.log(`‚úÖ Auth user existuje`);
  console.log(`   ID: ${user.id}`);
  console.log(`   Email: ${user.email}`);
  console.log(`   Created: ${user.created_at}\n`);
  
  // 2. Profile
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();
  
  if (!profile) {
    console.log('‚ö†Ô∏è  Profile neexistuje - vytv√°ram...');
    const { error: profileError } = await supabase
      .from('profiles')
      .insert({
        id: user.id,
        email: user.email,
        display_name: 'Mikail'
      });
    
    if (profileError) {
      console.error('‚ùå Chyba pri vytv√°ran√≠ profilu:', profileError);
      return;
    }
    console.log('‚úÖ Profile vytvoren√Ω\n');
  } else {
    console.log('‚úÖ Profile existuje');
    console.log(`   Display name: ${profile.display_name}\n`);
  }
  
  // 3. Household membership
  const { data: membership } = await supabase
    .from('household_members')
    .select('*, households(*)')
    .eq('user_id', user.id);
  
  let householdId;
  
  if (!membership || membership.length === 0) {
    console.log('‚ö†Ô∏è  Household neexistuje - vytv√°ram...');
    
    // Vytvor household
    const { data: newHousehold, error: householdError } = await supabase
      .from('households')
      .insert({ name: 'Mikail\'s Household' })
      .select()
      .single();
    
    if (householdError) {
      console.error('‚ùå Chyba pri vytv√°ran√≠ household:', householdError);
      return;
    }
    
    householdId = newHousehold.id;
    console.log(`‚úÖ Household vytvoren√Ω: ${householdId}`);
    
    // Pridaj usera do household
    const { error: memberError } = await supabase
      .from('household_members')
      .insert({
        household_id: householdId,
        user_id: user.id,
        role: 'owner'
      });
    
    if (memberError) {
      console.error('‚ùå Chyba pri prid√°van√≠ do household:', memberError);
      return;
    }
    console.log('‚úÖ User pridan√Ω ako owner\n');
  } else {
    householdId = membership[0].household_id;
    console.log(`‚úÖ Household existuje: ${membership[0].households.name}`);
    console.log(`   ID: ${householdId}`);
    console.log(`   Role: ${membership[0].role}\n`);
  }
  
  // 4. Categories
  const { data: existingCategories } = await supabase
    .from('categories')
    .select('*')
    .eq('household_id', householdId);
  
  if (!existingCategories || existingCategories.length === 0) {
    console.log('‚ö†Ô∏è  Kateg√≥rie neexistuj√∫ - vytv√°ram...');
    
    const categories = [
      { household_id: householdId, kind: 'expense', name: 'Potraviny' },
      { household_id: householdId, kind: 'expense', name: 'B√Ωvanie' },
      { household_id: householdId, kind: 'expense', name: 'Doprava' },
      { household_id: householdId, kind: 'expense', name: 'Zdravie' },
      { household_id: householdId, kind: 'expense', name: 'Z√°bava' },
      { household_id: householdId, kind: 'expense', name: 'Obleƒçenie' },
      { household_id: householdId, kind: 'income', name: 'Mzda' },
      { household_id: householdId, kind: 'income', name: 'Podnikanie' },
      { household_id: householdId, kind: 'income', name: 'Invest√≠cie' },
    ];
    
    const { error: catError } = await supabase
      .from('categories')
      .insert(categories);
    
    if (catError) {
      console.error('‚ùå Chyba pri vytv√°ran√≠ kateg√≥ri√≠:', catError);
      return;
    }
    console.log('‚úÖ Kateg√≥rie vytvoren√© (9)\n');
  } else {
    console.log(`‚úÖ Kateg√≥rie existuj√∫ (${existingCategories.length})`);
    existingCategories.forEach(c => {
      console.log(`   - ${c.name} (${c.kind})`);
    });
    console.log();
  }
  
  // 5. Demo data - Incomes
  const { data: existingIncomes } = await supabase
    .from('incomes')
    .select('*')
    .eq('household_id', householdId);
  
  if (!existingIncomes || existingIncomes.length === 0) {
    console.log('‚ö†Ô∏è  Pr√≠jmy neexistuj√∫ - vytv√°ram demo data...');
    
    // Z√≠skaj kateg√≥rie
    const { data: categories } = await supabase
      .from('categories')
      .select('*')
      .eq('household_id', householdId);
    
    const salaryCategory = categories.find(c => c.name === 'Mzda');
    const businessCategory = categories.find(c => c.name === 'Podnikanie');
    
    if (salaryCategory && businessCategory) {
      const today = new Date();
      const incomes = [
        {
          household_id: householdId,
          category_id: salaryCategory.id,
          amount: 2500.00,
          source: 'Mzda',
          note: 'Mesaƒçn√° mzda - okt√≥ber',
          date: new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        },
        {
          household_id: householdId,
          category_id: salaryCategory.id,
          amount: 2500.00,
          source: 'Mzda',
          note: 'Mesaƒçn√° mzda - september',
          date: new Date(today.getTime() - 35 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        },
        {
          household_id: householdId,
          category_id: salaryCategory.id,
          amount: 2500.00,
          source: 'Mzda',
          note: 'Mesaƒçn√° mzda - august',
          date: new Date(today.getTime() - 65 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        },
        {
          household_id: householdId,
          category_id: businessCategory.id,
          amount: 450.00,
          source: 'Freelance',
          note: 'Freelance projekt',
          date: new Date(today.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        }
      ];
      
      const { error: incomeError } = await supabase
        .from('incomes')
        .insert(incomes);
      
      if (incomeError) {
        console.error('‚ùå Chyba pri vytv√°ran√≠ pr√≠jmov:', incomeError);
      } else {
        console.log('‚úÖ Demo pr√≠jmy vytvoren√© (4)\n');
      }
    }
  } else {
    console.log(`‚úÖ Pr√≠jmy existuj√∫ (${existingIncomes.length})\n`);
  }
  
  // 6. Demo data - Expenses
  const { data: existingExpenses } = await supabase
    .from('expenses')
    .select('*')
    .eq('household_id', householdId);
  
  if (!existingExpenses || existingExpenses.length === 0) {
    console.log('‚ö†Ô∏è  V√Ωdavky neexistuj√∫ - vytv√°ram demo data...');
    
    const { data: categories } = await supabase
      .from('categories')
      .select('*')
      .eq('household_id', householdId);
    
    const foodCategory = categories.find(c => c.name === 'Potraviny');
    const housingCategory = categories.find(c => c.name === 'B√Ωvanie');
    const transportCategory = categories.find(c => c.name === 'Doprava');
    
    if (foodCategory && housingCategory && transportCategory) {
      const today = new Date();
      const expenses = [
        // Potraviny
        { household_id: householdId, category_id: foodCategory.id, amount: 85.50, merchant: 'Tesco', note: 'T√Ω≈ædenn√Ω n√°kup', date: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: householdId, category_id: foodCategory.id, amount: 42.30, merchant: 'Kaufland', note: 'Doplnenie', date: new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: householdId, category_id: foodCategory.id, amount: 78.90, merchant: 'Billa', note: 'N√°kup', date: new Date(today.getTime() - 9 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: householdId, category_id: foodCategory.id, amount: 95.20, merchant: 'Tesco', note: 'T√Ω≈ædenn√Ω n√°kup', date: new Date(today.getTime() - 16 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: householdId, category_id: foodCategory.id, amount: 38.50, merchant: 'Lidl', note: 'Ovocie a zelenina', date: new Date(today.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        
        // B√Ωvanie
        { household_id: householdId, category_id: housingCategory.id, amount: 650.00, merchant: 'Prenaj√≠mateƒæ', note: 'N√°jom za okt√≥ber', date: new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: householdId, category_id: housingCategory.id, amount: 120.00, merchant: 'ZSE', note: 'Elektrina a plyn', date: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: housingCategory, category_id: housingCategory.id, amount: 45.00, merchant: 'Orange', note: 'Internet a TV', date: new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        
        // Doprava
        { household_id: householdId, category_id: transportCategory.id, amount: 65.00, merchant: 'Shell', note: 'Tankovanie', date: new Date(today.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: householdId, category_id: transportCategory.id, amount: 58.00, merchant: 'OMV', note: 'Tankovanie', date: new Date(today.getTime() - 18 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
        { household_id: householdId, category_id: transportCategory.id, amount: 25.00, merchant: 'Parkovisko', note: 'Parkovn√© - centrum', date: new Date(today.getTime() - 12 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] }
      ];
      
      const { error: expenseError } = await supabase
        .from('expenses')
        .insert(expenses);
      
      if (expenseError) {
        console.error('‚ùå Chyba pri vytv√°ran√≠ v√Ωdavkov:', expenseError);
      } else {
        console.log('‚úÖ Demo v√Ωdavky vytvoren√© (11)\n');
      }
    }
  } else {
    console.log(`‚úÖ V√Ωdavky existuj√∫ (${existingExpenses.length})\n`);
  }
  
  // 7. Demo data - Loans
  const { data: existingLoans } = await supabase
    .from('loans')
    .select('*')
    .eq('household_id', householdId);
  
  if (!existingLoans || existingLoans.length === 0) {
    console.log('‚ö†Ô∏è  √övery neexistuj√∫ - vytv√°ram demo √∫ver...');
    
    const loan = {
      household_id: householdId,
      lender: 'Slovensk√° sporiteƒæ≈àa',
      loan_type: 'annuity',
      principal: 150000.00,
      annual_rate: 3.5,
      rate_type: 'fixed',
      day_count_convention: '30E/360',
      start_date: '2023-01-01',
      term_months: 360,
      status: 'active'
    };
    
    const { error: loanError } = await supabase
      .from('loans')
      .insert(loan);
    
    if (loanError) {
      console.error('‚ùå Chyba pri vytv√°ran√≠ √∫veru:', loanError);
    } else {
      console.log('‚úÖ Demo √∫ver vytvoren√Ω (hypot√©ka 150 000 ‚Ç¨)\n');
    }
  } else {
    console.log(`‚úÖ √övery existuj√∫ (${existingLoans.length})\n`);
  }
  
  // Final summary
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üìä FIN√ÅLNY STAV:\n');
  
  const { data: finalIncomes } = await supabase
    .from('incomes')
    .select('*')
    .eq('household_id', householdId);
  
  const { data: finalExpenses } = await supabase
    .from('expenses')
    .select('*')
    .eq('household_id', householdId);
  
  const { data: finalLoans } = await supabase
    .from('loans')
    .select('*')
    .eq('household_id', householdId);
  
  const { data: finalCategories } = await supabase
    .from('categories')
    .select('*')
    .eq('household_id', householdId);
  
  console.log(`   User ID: ${user.id}`);
  console.log(`   Household ID: ${householdId}`);
  console.log(`   Kateg√≥rie: ${finalCategories?.length || 0}`);
  console.log(`   Pr√≠jmy: ${finalIncomes?.length || 0}`);
  console.log(`   V√Ωdavky: ${finalExpenses?.length || 0}`);
  console.log(`   √övery: ${finalLoans?.length || 0}`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
  
  if (finalIncomes?.length > 0 && finalExpenses?.length > 0 && finalCategories?.length > 0) {
    console.log('‚úÖ HOTOVO! √öƒçet je plne funkƒçn√Ω.\n');
    console.log('üí° M√¥≈æe≈° sa prihl√°si≈• na: http://localhost:3000/auth/login');
    console.log('   Email: pirgozi1@gmail.com\n');
  } else {
    console.log('‚ö†Ô∏è  Niektor√© d√°ta ch√Ωbaj√∫. Skontroluj chyby vy≈°≈°ie.\n');
  }
}

diagnoseAndFix().catch(err => {
  console.error('\n‚ùå Fatal error:', err);
  process.exit(1);
});

